# Сети в Linux  
Настройка сетей в Linux на виртуальных машинах.

## Part 1. Инструмент ipcalc
### 1. Установим ipcalc:  
`sudo apt install ipcalc`
### 2. Сети и маски  
- Определяем адрес сети: 192.167.38.54/13  
![Alt text](images/Network-1.1.png)
Адрес сети - 192.160.0.0  
- Перевод масок:  
    - обычная запись: 255.255.255.0  
префиксная: /24   
двоичная запись: 11111111.11111111.11111111.00000000  
![Alt text](images/Network-1.2.png)
    - префиксная запись: /15  
обычная запись: 255.254.0.0  
двоичная запись: 11111111.11111110.00000000.00000000  
![Alt text](images/Network-1.3.png)
    - двоичная запись: 11111111.11111111.11111111.11110000  
обычная запись: 255.255.255.240  
префиксная запись: /28  
![Alt text](images/Network-1.4.png)  
- Минимальный и максимальный хост в сети 12.167.38.4 при масках:
    - /8  
HostMin: 12.0.0.1  
HostMax: 12.255.255.254  
![Alt text](images/Network-1.5.png)
    - 11111111.11111111.00000000.00000000  
HostMin: 12.167.0.1  
HostMax: 12.167.255.254
![Alt text](images/Network-1.6.png)
    - 255.255.254.0  
HostMin: 12.167.38.1  
HostMax: 12.167.39.254
![Alt text](images/Network-1.7.png)
    - /4  
HostMin: 0.0.0.1  
HostMax: 15.255.255.254
![Alt text](images/Network-1.8.png)
### 3. `Localhost`  — в компьютерных сетях, стандартное, официально зарезервированное, доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.255, RFC 2606), то есть для сети, состоящей только из одного компьютера.  
- Проверяем, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 
![Alt text](images/Network-1.9.png)
 194.34.23.100 -> нельзя  
 127.0.0.2 -> можно  
 127.1.0.1 -> можно  
 128.0.0.1 -> нельзя  
### 4. Диапазоны и сегменты сетей
 - Диапазоны для локальных сетей (все остальные относятся к публичным):  
Класс A - `10.0.0.0 — 10.255.255.255`  
Класс B - `172.16.0.0 — 172.31.255.255`  
Класс C - `192.168.0.0 — 192.168.255.255`  
 - Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных:   
 10.0.0.45 -> частный  
 134.43.0.2  -> публичный  
 192.168.4.2 -> частный  
 172.20.250.4 -> частный  
 172.0.2.1 -> публичный  
 192.172.0.1 -> публичный  
 172.68.0.2 -> публичный  
 172.16.255.255 -> частный  
 10.10.10.10 -> частный  
 192.169.168.1 -> публичный
- Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18.  
    - Для сети 10.10.0.0/18 диапазон возможных адресов  
    `10.10.0.1 - 10.10.63.254`
![Alt text](images/Network-1.10.png)
    - Возможные IP адреса: 10.10.0.2, 10.10.10.10, 10.10.1.255
    - Недопустимые IP адреса: 10.0.0.1, 10.10.100.1 
## Part 2. Статическая маршрутизация между двумя машинами
### 1. Поднять две виртуальные машины (далее -- ws1 и ws2)  
![Alt text](images/Network-2.1.png)  

С помощью команды `ip a` смотрим существующие сетевые интерфейсы:
- для машины **ws1**  
![Alt text](images/Network-2.2.png)  
- для машины **ws2**  
![Alt text](images/Network-2.3.png)  

Задаём адреса и маски для каждой машины:  
- Конфигурация netplan описывается языком YAML(язык для хранения информации в формате понятном человеку). Опишем ее детально:
    - network – слово-маркер, обозначающее старт логического блока сети;
    - ethernets – вид сетевого интерфейса, показывает, что дальше настраивается Ethernet-сеть;
    - enp0s3 – имя интерфейса, который надлежит сконфигурировать;
    - addresses – список IP-адресов, относящихся к интерфейсу;
    - dhcp4 - получение IPv4 адреса по DHCP, которое в данном случае необходимо отключить;
    - version – версия языка YAML
- для **ws1**: 192.168.100.10/16 и выполняем команду `netplan apply` для перезапуска сервиса сети:  
![Alt text](images/Network-2.4.png)
- для **ws2**: 172.24.116.8/12 и выполняем команду `netplan apply` для перезапуска сервиса сети:  
![Alt text](images/Network-2.5.png)
- проверяем сетевые интерфейсы для **ws1**  
![Alt text](images/Network-2.6.png)
- проверяем сетевые интерфейсы для **ws2**  
![Alt text](images/Network-2.7.png)
### 2. Добавление статического маршрута вручную  
Добавить статический маршрут от одной машины до другой и обратно можно при помощи команды:  
`ip r add [address we want to connect to] dev [network name]`   
- Добавим статический маршрут от **ws1** до **ws2** и пропингуем соединение:  
![Alt text](images/Network-2.8.png)  
- Проделаем тоже самое для второй машины:  
![Alt text](images/Network-2.9.png)  
### 3. Добавление статического маршрута с сохранением  
- Перезапускаем машины при помощи команды `reboot`  
- Добавляем статический маршрут от **ws1** до **ws2** с помощью файла etc/netplan/00-installer-config.yaml и перезапускаем сервисы сети через команду `sudo netplan apply`:  
![Alt text](images/Network-2.10.png)  
- Добавляем статический маршрут от **ws2** до **ws1** с помощью файла etc/netplan/00-installer-config.yaml и перезапускаем сервисы сети через команду `sudo netplan apply`:  
![Alt text](images/Network-2.11.png)  
- Пропингуем соединение между машинами:
    - от **ws1** до **ws2**  
    ![Alt text](images/Network-2.12.png)
    - от **ws2** до **ws1**  
    ![Alt text](images/Network-2.13.png)
## Part 3. Утилита iperf3
### 1. Перевести и записать в отчёт:  
- 8 Mbps = 1 MB/s
- 100 MB/s = 800000 Kbps 
- 1 Gbps =  1000 Mbps
### 2. Утилита iperf3  
- Устанавливаем утилиты **iperf3** на обе машины с помощью команды `sudo apt install iperf3`  
- Измерение скорость соединения между **ws1** и **ws2**:  
    - делаем машину **ws1** сервером:  
    `iperf3 -s`  
     ![Alt text](images/Network-3.1.png)
    - далее на машине **ws2** измеряем скорость соединения через команду:  
    `iperf3 -c 172.24.116.8 -f K`  
    ![Alt text](images/Network-3.2.png)
    - вывод с машины **ws1**:
    ![Alt text](images/Network-3.3.png)

## Part 4. Сетевой экран
### 1. Утилита iptables  
- Устанавливаем утилиты **iperf3** на обе машины с помощью команды `sudo apt install iptables`  
- Создаём файл **/etc/firewall.sh**, имитирующий фаерволл, на **ws1** и **ws2**:  
![Alt text](images/Network-4.1.png)
- Добавляем в файл подряд следующие правила:
    1. На ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
    2. На ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
    3. Открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
    4. Запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
    5. Разрешить echo reply (машина должна "пинговаться")  
Файл **/etc/firewall.sh** на **ws1**:
![Alt text](images/Network-4.2.png)
Файл **/etc/firewall.sh** на **ws2**:  
![Alt text](images/Network-4.3.png)
- Запустим файлы на обеих машинах командами `sudo chmod +x /etc/firewall.sh` и `sudo /etc/firewall.sh`  
    - Запуск на **ws1**:
    ![Alt text](images/Network-4.4.png)
    - Запуск на **ws2**:  
    ![Alt text](images/Network-4.5.png)  
Разница в стратегиях:  
утилита **iptables** выполняет прописанные правила подряд сверху вниз по порядку, поэтому на машине **ws1** пинг не случится, так как первой стоит команда **REJECT**, которая отклонит пакет подключения. Во втором случае, на машине  **ws2** пинг пройдёт, так как сначала стоит команда **ACCEPT**, разрешающая прохождения пакета подключения.
## 4.2. Утилита nmap
### 1. Командой `ping` найдём машину, которая не "пингуется":  
- пингуем **ws2** c машины **ws1** -> машины пингуются:
![Alt text](images/Network-4.6.png)
- пингуем **ws1** c машины **ws2** -> машины не пингуются:  
![Alt text](images/Network-4.7.png)  
### 2. Утилитой `nmap` показать, что хост машины запущен:  
![Alt text](images/Network-4.8.png)  
Строка 'Host is up' говорит о том, что хост машины запущен
### 3. Сохраняем дампы образов виртуальных машин:  
![Alt text](images/Network-4.9.png)
## Part 5. Статическая маршрутизация сети
Поднимаем пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))
![Alt text](images/Network-5.1.png)
### 1. Настройка адресов машин  
Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке:  
![Alt text](images/part5_network.png)

- содержание файла `etc/netplan/00-installer-config.yaml` для машины **ws11**:  
![Alt text](images/Network-5.2.png)
- содержание файла `etc/netplan/00-installer-config.yaml` для машины **r1**:  
![Alt text](images/Network-5.3.png)
- содержание файла `etc/netplan/00-installer-config.yaml` для машины **r2**:  
![Alt text](images/Network-5.4.png) [Title](LinuxNetwork_report.md)
- содержание файла `etc/netplan/00-installer-config.yaml` для машины **ws21**:  
![Alt text](images/Network-5.5.png)
- содержание файла `etc/netplan/00-installer-config.yaml` для машины **ws22**:    
![Alt text](images/Network-5.6.png)  

Перезапустим сервис сети и командой `ip -4 a` проверим, что адрес машины задан верно:
- машина **ws11**:  
![Alt text](images/Network-5.7.png)
- машина **r1**:  
![Alt text](images/Network-5.8.png)
- машина **r2**:  
![Alt text](images/Network-5.9.png)
- машина **ws21**:  
![Alt text](images/Network-5.10.png)
- машина **ws22**:  
![Alt text](images/Network-5.11.png)  

Пропингуем  **ws22** с **ws21**:  
![Alt text](images/Network-5.12.png)
Аналогично пропингуем **r1** с **ws11**:
![Alt text](images/Network-5.13.png)
### 2. Включение переадресации IP-адресов
Для включения переадресации IP, выполните команду на роутерах `sysctl -w net.ipv4.ip_forward=1`  
- роутер **r1**:  
![Alt text](images/Network-5.14.png)
- роутер **r**:  
![Alt text](images/Network-5.15.png)

Далее откроем файл `/etc/sysctl.conf` и добавьте в него следующую строку: **net.ipv4.ip_forward = 1** 
- роутер **r1**:  
![Alt text](images/Network-5.16.png)
- роутер **r2**:  
![Alt text](images/Network-5.17.png)  
### 3. Установка маршрута по-умолчанию
Настроим маршрут по-умолчанию (шлюз) для рабочих станций  
Для этого добавить **default** перед IP роутера в файле конфигураций
- машина **ws11**:  
![Alt text](images/Network-5.18.png)  
- машина **ws21**:  
![Alt text](images/Network-5.19.png)
- машина **ws22**:  
![Alt text](images/Network-5.20.png)

Вызваем `ip r`, чтобы показать, что добавился маршрут в таблицу маршрутизации:  
- машина **ws11**:  
![Alt text](images/Network-5.21.png)
- машина **ws21**:  
![Alt text](images/Network-5.22.png)
- машина **ws22**:  
![Alt text](images/Network-5.23.png)  

Пропингуем с машины **ws11** роутер **r2**:  
![Alt text](images/Network-5.24.png)  
Для того, чтобы проверить, что пинг проходит используем команду: `sudo tcpdump -tn -i enp0s9 -c4`  
![Alt text](images/Network-5.25.png)  
### 4. Добавление статических маршрутов
Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций:
- роутер **r1**:  
![Alt text](images/Network-5.26.png)
- роутер **r1**:  
![Alt text](images/Network-5.27.png)  

Вызываем `ip r`, чтобы показать таблицы с маршрутами на обоих роутерах:
- роутер **r1**:  
![Alt text](images/Network-5.28.png)
- роутер **r1**:  
![Alt text](images/Network-5.29.png)

Запустим команды на ws11: `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`:  
![Alt text](images/Network-5.30.png)  
Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию, потому что роутер считает маршруты с наибольшей маской более приоритетными, таким образом маршрут с маской /0 - самый последний по приоритету

### 5. Построение списка маршрутизаторов
Запустим на **r1** команду дампа: `tcpdump -tnv -i enp0s9`  
![Alt text](images/Network-5.31.png)  
При помощи команды `sudo traceroute 10.20.0.10` построим список маршрутизаторов на пути от **ws11** до **ws21**:  
![Alt text](images/Network-5.32.png)  
Для определения промежуточных маршрутизаторов **traceroute** отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit»  
### 6. Использование протокола ICMP при маршрутизации
Запустить на **r1** перехват сетевого трафика, проходящего через eth0 с помощью команды: `sudo tcpdump -n -i eth0s8 icmp`  
![Alt text](images/Network-5.33.png)  
Пропингуем с **ws11** несуществующий IP (например, 10.30.0.111) с помощью команды: `ping -c4 10.30.0.111`  
![Alt text](images/Network-5.34.png)  
Сохраним дампы образов виртуальных машин:  
![Alt text](images/Network-5.35.png)  
## Part 6. Динамическая настройка IP с помощью DHCP
Для **r2** настроим в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP: 
- установим нужные нам утилиты, чтобы получить файл **dhcpd.conf**: `sudo apt install isc-dhcp-server` и `sudo apt install resolvconf`
- указываем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети в файле /etc/dhcp/dhcpd.conf:  
![Alt text](images/Network-6.1.png)  
- в файле resolv.conf прописать `nameserver 8.8.8.8`
![Alt text](images/Network-6.2.png)  
- перезагрузим службу DHCP командой `sudo systemctl restart isc-dhcp-server`  
![Alt text](images/Network-6.3.png)
- машину **ws21** перезагрузим при помощи `reboot` и через `ip a` покажем, что она получила адрес:  
![Alt text](images/Network-6.4.png)
- пропингуем **ws22** с **ws21**:  
![Alt text](images/Network-6.5.png)  

Укажем MAC адрес у **ws11**, для этого в etc/netplan/00-installer-config.yaml добавим строки: `macaddress: 10:10:10:10:10:BA` и `dhcp4: true`:  
![Alt text](images/Network-6.6.png)  
Для **r1** аналогично настроим **r2**, но сделаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11):  
- установим DHCP на **r1** командой `sudo apt install isc-dhcp-server`
- отредактируем файл /etc/dhcp/dhcpd.conf на **r1**:  
![Alt text](images/Network-6.7.png)
- отредактируем файл resolv.conf на **r1**:  
![Alt text](images/Network-6.8.png)
- перезагрузим службу DHCP командой `sudo systemctl restart isc-dhcp-server`  
![Alt text](images/Network-6.9.png)
- перезагрузим **ws11** при помощи `reboot` и через `ip a` покажем, что она получила адрес:  
![Alt text](images/Network-6.10.png)
- в настройках машины **ws11** пропишем MAC Address:  
![Alt text](images/Network-6.12.png)
- проведём аналогичные тесты:  
![Alt text](images/Network-6.11.png)  

Запросим с **ws21** обновление ip адреса:
- IP до обновления:  
![Alt text](images/Network-6.13.png)
- удаляем старые адреса `sudo dhclient -r` и получаем новые `sudo dhclient`  
![Alt text](images/Network-6.14.png)  
- Опции **DHCP**, которые мы используем:
    - **subnet** – сеть, в которой будут работать настройки;
    - **netmask** - маска подсети;
    - **range** – диапазон IP-адресов;
    - **option routers** – шлюз по-умолчанию;
    - **option domain-name-servers** – DNS-сервера;
    - **host** - привязка к MAC-адресу

Сохраним дампы образов виртуальных машин:  
![Alt text](images/Network-6.15.png)

## Part 7. NAT
В файле /etc/apache2/ports.conf на  и **r1** изменим строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделаем сервер Apache2 общедоступным:  
- роутер **r1**  
![Alt text](images/Network-7.1.png)
- машина **ws22**  
![Alt text](images/Network-7.2.png)

Запустим веб-сервер Apache командой `service apache2 start` на **ws22** и **r1**:
- машина **ws22** 
![Alt text](images/Network-7.3.png)
- роутер **r1**  
![Alt text](images/Network-7.4.png)  

Добавляем в фаервол, созданный по аналогии с фаерволом из Части 4, на **r2** следующие правила:
1) Удаление правил в таблице `filter - iptables -F`
2) Удаление правил в таблице "NAT" - `iptables -F -t nat`
3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`  

![Alt text](images/Network-7.5.png)  
Запускаем и проверяем:  
![Alt text](images/Network-7.6.png)

Проверить соединение между **ws22** и **r1** командой `ping`. При запуске файла с этими правилами, **ws22** не должна "пинговаться" с **r1**:  
![Alt text](images/Network-7.7.png)  
Добавить в файл ещё одно правило:  

4. разрешить маршрутизацию всех пакетов протокола ICMP: 
![Alt text](images/Network-7.8.png)

Запустим и проверим:  
![Alt text](images/Network-7.9.png)  
Проверить соединение между **ws22** и **r1** командой `ping`. При запуске файла с этими правилами, **ws22** должна "пинговаться" с **r1**:
![Alt text](images/Network-7.10.png)
Добавим в файл ещё два правила:  

5. Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за **r2** (по обозначениям из Части 5 - сеть 10.20.0.0)

6. Включить **DNAT** на 8080 порт машины **r2** и добавить к веб-серверу Apache, запущенному на **ws22**, доступ извне сети  
![Alt text](images/Network-7.11.png)  

И запустим систему:
![Alt text](images/Network-7.12.png)

Отключаем сетевой интерфейс **NAT** (проверяем командой `ip a`) в VirtualBox 
![Alt text](images/Network-7.12a.png)
На скриншоте видно, что адаптера **enp0s8**, который отвечал за интернет, нет  

Проверяем соединение по TCP для SNAT, для этого с **ws22** подключиться к серверу Apache на **r1** командой:
`telnet [адрес] [порт]`
![Alt text](images/Network-7.13.png)
Проверить соединение по TCP для DNAT, для этого с **r1** подключиться к серверу Apache на **ws22** командой `telnet` (обращаться по адресу **r2** и порту 8080)
![Alt text](images/Network-7.14.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels  
Запустим на **r2** фаервол с правилами из Части 7:  
![Alt text](images/Network-8.1.png)  
Воспользуемся Local TCP forwarding с **ws21** до **ws22**, чтобы получить доступ к веб-серверу на **ws22** с **ws21** `sudo ssh -L 8080:localhost:80 student@10.20.0.20`:  
![Alt text](images/Network-8.3.png)  
Воспользуемся Remote TCP forwarding c **ws11** до **ws22**, чтобы получить доступ к веб-серверу на **ws22** с **ws11** `sudo ssh -R 8080:localhost:80 student@10.20.0.20`:  
![Alt text](images/Network-8.4.png)  
Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами fn + option + F2) и выполните команду:
`telnet 127.0.0.1 [локальный порт]`  
![Alt text](images/Network-8.5.png)